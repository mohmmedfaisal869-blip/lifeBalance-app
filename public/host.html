<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LifeBalance ‚Äî Host Page</title>
    <style>
      body { font-family: Inter, Arial, sans-serif; background:#f8fafc; color:#0f172a; padding:24px }
      table { width:100%; border-collapse:collapse; margin-top:12px }
      th,td { padding:12px; border:1px solid #e2e8f0; text-align:left; vertical-align:top }
      th { background:#0ea5e9; color:white }
      .small { font-size:12px; color:#475569 }
      .mono { font-family: monospace; font-size:12px }
      pre { white-space:pre-wrap; word-break:break-word }
      .card { background:white; border-radius:16px; padding:20px; margin:12px 0; box-shadow:0 4px 6px rgba(0,0,0,0.1); border:1px solid #e2e8f0 }
      .card h3 { margin:0 0 12px 0; color:#0ea5e9 }
      .stat-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:12px }
      .stat-box { background:#f1f5f9; padding:16px; border-radius:12px; text-align:center }
      .stat-box .value { font-size:28px; font-weight:800; color:#0f172a }
      .stat-box .label { font-size:11px; color:#64748b; text-transform:uppercase; letter-spacing:1px }
      .quran-card { background: linear-gradient(135deg, #d97706 0%, #b45309 100%); color:white }
      .quran-card h3 { color:white }
      .quran-card .stat-box { background:rgba(255,255,255,0.2) }
      .quran-card .stat-box .value { color:white }
      .quran-card .stat-box .label { color:rgba(255,255,255,0.8) }
      .tab-buttons { display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap }
      .tab-btn { padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:600 }
      .tab-btn.active { background:#0ea5e9; color:white }
      .tab-btn:not(.active) { background:#e2e8f0 }
      .tab-content { display:none }
      .tab-content.active { display:block }
      .loading { text-align:center; padding:40px; color:#64748b }
      .db-badge { background:#10b981; color:white; padding:4px 12px; border-radius:20px; font-size:12px; margin-left:8px }
    </style>
  </head>
  <body>
    <h1>üè† Host Page ‚Äî LifeBalance Admin <span class="db-badge">‚òÅÔ∏è Cloud Database</span></h1>
    <p class="small">This page reads user data from Supabase cloud database ‚Äî works from any browser/device!</p>
    
    <div id="auth" style="max-width:480px;margin-top:16px"></div>
    <div id="content"><div class="loading">‚è≥ Loading from database...</div></div>

    <script>
      // Supabase configuration
      const SUPABASE_URL = 'https://hagdmdogxwuueooczqji.supabase.co';
      const SUPABASE_KEY = 'sb_publishable_aS384Eu8SSr5ij21ykCkMA_nMtbOR8A';

      // Fetch users from Supabase
      async function fetchUsersFromSupabase() {
        try {
          const response = await fetch(`${SUPABASE_URL}/rest/v1/users?select=*&order=updated_at.desc`, {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
            }
          });
          if (!response.ok) throw new Error('Failed to fetch');
          return await response.json();
        } catch (error) {
          console.error('Supabase fetch error:', error);
          return [];
        }
      }

      if (!localStorage.getItem('host_password')) {
        localStorage.setItem('host_password', 'Fsa12joh1moh2FMJZ');
      }

      function readSuggestions() {
        try {
          const raw = localStorage.getItem('lifebalance_suggestions');
          return raw ? JSON.parse(raw) : [];
        } catch (e) { return []; }
      }

      function isLoggedIn(){
        return sessionStorage.getItem('host_logged_in') === '1';
      }

      function setLoggedIn(name){
        sessionStorage.setItem('host_logged_in','1');
        sessionStorage.setItem('host_admin_name', name||'admin');
      }

      function logout(){
        sessionStorage.removeItem('host_logged_in');
        sessionStorage.removeItem('host_admin_name');
        location.reload();
      }

      function showAuth() {
        const auth = document.getElementById('auth');
        const stored = localStorage.getItem('host_password');
        if (!stored) {
          auth.innerHTML = `<div class="card"><h3>üîê Set Host Password</h3>
            <p class="small">No host password set. Create one to protect this page.</p>
            <div style="margin-top:8px"><input id="hpw" placeholder="New password" type="password" style="width:100%;padding:10px;border-radius:8px;border:1px solid #cbd5e1" /></div>
            <div style="margin-top:8px"><button id="hpwBtn" style="padding:10px 16px;background:#0ea5e9;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600">Set Password</button></div></div>`;
          document.getElementById('hpwBtn').onclick = function(){
            const v = document.getElementById('hpw').value;
            if(!v) return alert('Please enter a password');
            localStorage.setItem('host_password', v);
            alert('Password saved. Please login.');
            showAuth();
          };
        } else {
          auth.innerHTML = `<div class="card"><h3>üîê Host Login</h3>
            <div style="margin-top:8px"><label>Name</label><input id="hn" placeholder="admin name" style="width:100%;padding:10px;border-radius:8px;border:1px solid #cbd5e1;margin-top:4px" /></div>
            <div style="margin-top:12px"><label>Password</label><input id="hpwLogin" placeholder="password" type="password" style="width:100%;padding:10px;border-radius:8px;border:1px solid #cbd5e1;margin-top:4px" /></div>
            <div style="margin-top:12px;display:flex;gap:8px"><button id="loginBtn" style="padding:10px 16px;background:#0ea5e9;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600">Login</button><button id="clearBtn" style="padding:10px 16px;background:#e2e8f0;border:none;border-radius:8px;cursor:pointer">Clear</button></div></div>`;
          document.getElementById('loginBtn').onclick = function(){
            const name = document.getElementById('hn').value || 'admin';
            const pw = document.getElementById('hpwLogin').value;
            if(pw === localStorage.getItem('host_password')){ setLoggedIn(name); render(); document.getElementById('auth').style.display='none'; }
            else alert('Incorrect password');
          };
          document.getElementById('clearBtn').onclick = function(){ document.getElementById('hn').value=''; document.getElementById('hpwLogin').value=''; };
        }
      }

      async function render() {
        if(!isLoggedIn()){ showAuth(); document.getElementById('content').innerHTML = '<p class="small" style="margin-top:20px">Please login to view host data.</p>'; return; }
        
        const adminName = sessionStorage.getItem('host_admin_name')||'admin';
        document.getElementById('auth').innerHTML = `<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap">
          <span style="background:#10b981;color:white;padding:8px 16px;border-radius:20px;font-weight:600">‚úì Logged in as ${adminName}</span>
          <button id="logoutBtn" style="padding:8px 16px;border-radius:8px;border:1px solid #e2e8f0;cursor:pointer">Logout</button>
          <button id="refreshBtn" style="padding:8px 16px;border-radius:8px;background:#0ea5e9;color:white;border:none;cursor:pointer">üîÑ Refresh</button>
        </div>`;
        document.getElementById('logoutBtn').onclick = logout;
        document.getElementById('refreshBtn').onclick = render;

        document.getElementById('content').innerHTML = '<div class="loading">‚è≥ Loading from Supabase...</div>';
        
        // Fetch from Supabase
        const users = await fetchUsersFromSupabase();
        const suggestions = readSuggestions();

        // Calculate totals
        let totalQuranPages = 0;
        let totalWaterIntake = 0;
        let totalTasks = 0;
        let totalGratitude = 0;
        
        users.forEach(u => {
          totalQuranPages += u.quran_total_pages || 0;
          totalWaterIntake += u.water_intake || 0;
          totalTasks += u.tasks_completed || 0;
          totalGratitude += u.gratitude_count || 0;
        });

        let html = `
          <div class="tab-buttons">
            <button class="tab-btn active" onclick="showTab('overview')">üìä Overview</button>
            <button class="tab-btn" onclick="showTab('quran')">üìñ Quran Stats</button>
            <button class="tab-btn" onclick="showTab('users')">üë• Users</button>
            <button class="tab-btn" onclick="showTab('suggestions')">üí¨ Suggestions</button>
          </div>

          <!-- Overview Tab -->
          <div id="tab-overview" class="tab-content active">
            <div class="card">
              <h3>üìä Overall Statistics</h3>
              <div class="stat-grid">
                <div class="stat-box">
                  <div class="value">${users.length}</div>
                  <div class="label">Total Users</div>
                </div>
                <div class="stat-box">
                  <div class="value">${totalQuranPages}</div>
                  <div class="label">Quran Pages Read</div>
                </div>
                <div class="stat-box">
                  <div class="value">${totalWaterIntake} ml</div>
                  <div class="label">Water Consumed</div>
                </div>
                <div class="stat-box">
                  <div class="value">${totalTasks}</div>
                  <div class="label">Tasks Completed</div>
                </div>
                <div class="stat-box">
                  <div class="value">${totalGratitude}</div>
                  <div class="label">Gratitude Notes</div>
                </div>
                <div class="stat-box">
                  <div class="value">${suggestions.length}</div>
                  <div class="label">Suggestions</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Quran Tab -->
          <div id="tab-quran" class="tab-content">
            <div class="card quran-card">
              <h3>üìñ Quran Reading Statistics</h3>
              <div class="stat-grid">
                <div class="stat-box">
                  <div class="value">${totalQuranPages}</div>
                  <div class="label">Total Pages Read (All Users)</div>
                </div>
              </div>
            </div>
            <div class="card">
              <h3>üìñ Per-User Quran Stats</h3>
              <table>
                <thead><tr><th>User</th><th>Pages Today</th><th>Daily Goal</th><th>Total Pages</th><th>Streak Days</th><th>Progress %</th></tr></thead>
                <tbody>`;
        
        users.forEach(u => {
          const pagesRead = u.quran_pages_today || 0;
          const pagesGoal = u.quran_daily_goal || 5;
          const totalPages = u.quran_total_pages || 0;
          const streakDays = u.quran_streak || 0;
          const progress = Math.min(100, (pagesRead / Math.max(1, pagesGoal)) * 100).toFixed(0);
          html += `<tr>
            <td>${u.name || u.email || u.id}</td>
            <td><strong>${pagesRead}</strong></td>
            <td>${pagesGoal}</td>
            <td style="color:#d97706;font-weight:bold">${totalPages}</td>
            <td style="color:#10b981;font-weight:bold">${streakDays} days</td>
            <td>
              <div style="background:#e2e8f0;border-radius:4px;height:20px;width:100px;overflow:hidden">
                <div style="background:#d97706;height:100%;width:${progress}%"></div>
              </div>
              ${progress}%
            </td>
          </tr>`;
        });
        
        html += `</tbody></table></div></div>

          <!-- Users Tab -->
          <div id="tab-users" class="tab-content">
            <div class="card">
              <h3>üë• Registered Users (${users.length})</h3>
              <table>
                <thead><tr><th>Email</th><th>Name</th><th>Guest?</th><th>Water</th><th>Quran Today</th><th>Last Updated</th></tr></thead>
                <tbody>`;
        
        users.forEach(u => {
          html += `<tr>
            <td class="mono">${u.email || u.id}</td>
            <td>${u.name || '‚Äî'}</td>
            <td>${u.is_guest ? '‚úì Yes' : 'No'}</td>
            <td>${u.water_intake || 0} / ${u.water_goal || 2000} ml</td>
            <td>${u.quran_pages_today || 0} pages</td>
            <td>${u.updated_at ? new Date(u.updated_at).toLocaleString() : '‚Äî'}</td>
          </tr>`;
        });
        
        html += `</tbody></table></div></div>

          <!-- Suggestions Tab -->
          <div id="tab-suggestions" class="tab-content">
            <div class="card">
              <h3>üí¨ User Suggestions (${suggestions.length})</h3>`;
        
        if (suggestions.length) {
          html += `<table><thead><tr><th>Time</th><th>User</th><th>Message</th></tr></thead><tbody>`;
          suggestions.forEach(s => {
            const when = s.ts ? new Date(s.ts).toLocaleString() : '‚Äî';
            const user = s.user ? (s.user.name || s.user.email || 'Unknown') : 'Anonymous';
            html += `<tr><td class="mono">${when}</td><td>${user}</td><td><pre>${s.text || ''}</pre></td></tr>`;
          });
          html += `</tbody></table>`;
        } else {
          html += `<p class="small">No suggestions yet.</p>`;
        }
        
        html += `</div></div>`;

        document.getElementById('content').innerHTML = html;
      }

      function showTab(name) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + name).classList.add('active');
        event.target.classList.add('active');
      }

      render();
    </script>
  </body>
</html>
